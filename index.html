<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Meysam Player - Final Build</title>

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
  :root{
    --accent: #FF0000; 
    --pill-bg: rgba(255, 255, 255, 0.15); 
    --pill-bg-hover: rgba(255, 255, 255, 0.25);
    --panel-bg: rgba(20, 20, 20, 0.95);
    --text-shadow: 0 1px 2px rgba(0,0,0,0.8);
  }

  * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
  
  html, body {
    height: 100%; margin: 0; 
    background: #000; 
    color: #fff; 
    font-family: Roboto, Arial, sans-serif;
    overflow: hidden; 
  }

  /* --- INTRO STYLES --- */
  #overlay {
    position: fixed; inset: 0; background: #000; z-index: 1000;
    display: flex; align-items: center; justify-content: center; perspective: 1000px;
  }
  .welcome-text {
    color: #ffffff; font-size: 5em; opacity: 0;
    text-shadow: 0 0 15px #fff, 0 0 30px #fff, 0 0 60px #00f0ff, 0 0 120px #00f0ff;
    transform: translateZ(-50px);
    transition: transform 1s linear, opacity 0.8s ease;
    position: absolute; font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; pointer-events: none;
  }

  /* --- PLAYER STYLES --- */
  .player-wrap {
    position: relative; width: 100%; max-width: 100%; height: 100vh;   
    background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center;
    opacity: 0; transition: opacity 1s ease;
  }
  
  @media (min-width: 960px) {
      .player-wrap {
          height: auto; max-width: 960px; margin: 40px auto;
          border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); aspect-ratio: 16/9;
      }
  }

  .player-wrap.hide-controls { cursor: none; }
  .player-wrap.hide-controls .controls { opacity: 0; pointer-events: none; }
  .player-wrap.paused .controls { opacity: 1 !important; pointer-events: auto !important; }

  video { width: 100%; height: 100%; object-fit: contain; display: block; }

  #customSubtitleLayer {
    position: absolute; bottom: 70px; left: 20px; right: 20px;
    text-align: center; pointer-events: none; z-index: 5;
    transition: transform 0.2s ease, bottom 0.2s ease;
  }
  #customSubtitleText {
    display: inline-block; background-color: rgba(0, 0, 0, 0.6);
    padding: 6px 12px; border-radius: 6px; color: #fff;
    font-size: 16px; line-height: 1.5; text-shadow: 0 2px 4px rgba(0,0,0,1);
    white-space: pre-line; transition: all 0.2s;
  }

  .controls {
    position: absolute; left: 0; right: 0; bottom: 0;
    padding: 0 16px 16px 16px;
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 60%, rgba(0,0,0,0) 100%);
    transition: opacity 0.3s ease; display: flex; flex-direction: column; gap: 10px; z-index: 20; direction: ltr; 
  }

  .progress-wrap {
    height: 20px; cursor: pointer; display: flex; align-items: center; margin-bottom: 0; position: relative;
  }
  .progress {
    width: 100%; height: 4px; background: rgba(255,255,255,0.3); position: relative; border-radius: 2px; transition: height 0.1s;
  }
  .progress-wrap:hover .progress { height: 6px; }
  .progress .bar {
    height: 100%; background: var(--accent); width: 0%; border-radius: 2px; position: relative;
  }
  .progress .bar::after {
    content: ''; position: absolute; right: -8px; top: 50%; transform: translateY(-50%) scale(1); 
    width: 16px; height: 16px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }
  
  /* Tooltip Fixed Styles */
  .seek-tooltip { 
    position: absolute; bottom: 25px; background: rgba(0,0,0,0.9); 
    padding: 4px 8px; border-radius: 4px; font-size: 12px; 
    opacity: 0; pointer-events: none; transform: translateX(-50%);
    transition: opacity 0.1s; white-space: nowrap;
  }
  .progress-wrap:hover .seek-tooltip { opacity: 1; }

  .controls-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .section-left, .section-right { display: flex; align-items: center; gap: 8px; }
  .section-center-spacer { flex-grow: 1; }

  button.icon {
    background: transparent; border: 0; color: #fff; width: 44px; height: 44px; 
    padding: 0; margin: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative;
  }
  button.icon i { font-size: 28px; filter: drop-shadow(var(--text-shadow)); }
  button.icon:active { transform: scale(0.9); }
  button.icon.active::after {
    content: ''; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
    width: 16px; height: 3px; background-color: var(--accent); border-radius: 2px;
  }

  #playBtn { width: 48px; height: 48px; background: var(--pill-bg); border-radius: 50%; }

  .volume-control {
    position: relative; background: var(--pill-bg); border-radius: 999px; height: 44px; width: 44px;
    display: flex; align-items: center; overflow: hidden; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  @media (hover: hover) {
    .volume-control:hover { width: 140px; background: var(--pill-bg-hover); }
    .volume-control:hover #volume { opacity: 1; }
  }
  #muteBtn { width: 44px; height: 44px; flex-shrink: 0; z-index: 2; }
  #volume {
    width: 80px; margin-left: 2px; margin-right: 14px; cursor: pointer; opacity: 1; background: transparent; -webkit-appearance: none;
  }
  #volume::-webkit-slider-runnable-track { height: 4px; background: rgba(255,255,255,0.4); border-radius: 2px; }
  #volume::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #fff; margin-top: -5px; }

  .time-display {
    height: 44px; padding: 0 16px; background: var(--pill-bg); border-radius: 999px;
    display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 500; font-variant-numeric: tabular-nums; 
  }
  .icon-group {
    height: 44px; background: var(--pill-bg); border-radius: 999px; display: flex; align-items: center; padding: 0 4px; position: relative;
  }

  /* MENU STYLES */
  .settings-menu-container {
    position: absolute; bottom: 60px; right: 16px; width: 260px;
    background: var(--panel-bg); border-radius: 12px; overflow: hidden; display: none; z-index: 100;
    opacity: 0; transform: translateY(10px); transition: opacity 0.2s, transform 0.2s;
    box-shadow: 0 4px 20px rgba(0,0,0,0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  }
  @media (max-width: 600px) {
      .settings-menu-container {
          position: fixed; bottom: 0; left: 0; right: 0; width: 100%;
          border-radius: 16px 16px 0 0; transform: translateY(100%); margin: 0;
      }
      .settings-menu-container.active { transform: translateY(0); }
      .time-display { display: none; } 
      .volume-control { display: none; } 
  }
  .settings-menu-container.active { display: block; opacity: 1; transform: translateY(0); }
  .menu-content { display: none; flex-direction: column; padding: 8px 0; max-height: 60vh; overflow-y: auto; }
  .menu-content.active-panel { display: flex; animation: fadeInPanel 0.2s ease; }
  @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
  .panel-header {
    display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); 
    margin-bottom: 4px; color: #eee; font-size: 16px; font-weight: bold;
  }
  .panel-header button { margin-right: 12px; padding: 4px; border-radius: 50%; }
  .menu-item {
    width: 100%; text-align: left; padding: 14px 20px; background: transparent; border: 0; color: #f1f1f1; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center; font-size: 15px;
  }
  .menu-item:active { background: rgba(255,255,255,0.1); }
  .menu-item .left-icon { margin-right: 12px; font-size: 22px; color: #aaa; }
  .menu-value { opacity: 0.7; font-size: 14px; display: flex; align-items: center; gap: 4px;}
  .menu-item.selected::before { content: 'âœ“'; margin-right: 10px; font-weight: bold; color: var(--accent); }
  .menu-item:not(.selected) { padding-left: 35px; }

  .color-grid { display: flex; gap: 12px; padding: 16px; justify-content: center; }
  .color-swatch { 
      width: 36px; height: 36px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s;
  }
  .color-swatch.active-swatch { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
  .setting-slider-wrap { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
  .setting-slider { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; padding: 10px 0; }
  .setting-slider::-webkit-slider-runnable-track { height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
  .setting-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--accent); margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

  .loader-wrap {
    position: absolute; inset: 0; pointer-events: none; display: none; align-items: center; justify-content: center; z-index: 5;
  }
  .loader-wrap.active { display: flex; }
  .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  .center-play-overlay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px;
    background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center;
    pointer-events: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(4px); z-index: 10;
  }
  .center-play-overlay.show-icon { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
  .center-play-overlay i { font-size: 48px; color: #fff; }

  .seek-feedback {
    position: absolute; top: 50%; transform: translateY(-50%); width: 80px; height: 80px; background: rgba(0,0,0,0.6); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; z-index: 15;
  }
  .seek-feedback.left { left: 20%; }
  .seek-feedback.right { right: 20%; }
  .seek-feedback.show { animation: feedbackFade 0.5s ease-out forwards; }
  .seek-feedback i { font-size: 36px; color: #fff; }
  @keyframes feedbackFade { 0% { opacity: 0; transform: translateY(-50%) scale(0.5); } 50% { opacity: 1; transform: translateY(-50%) scale(1.1); } 100% { opacity: 0; transform: translateY(-50%) scale(1.5); } }

</style>
</head>
<body>

<div id="overlay">
  <div id="welcome1" class="welcome-text">Welcome</div>
  <div id="welcome2" class="welcome-text">to</div>
  <div id="welcome3" class="welcome-text">Meysam Player</div>
</div>

<div class="player-wrap paused" id="playerWrap"> 
  <video id="video" crossorigin="anonymous" playsinline> 
    <source src="https://berlin.saymyname.website/Movies/2025/22898462/The_Conjuring_The_Last_Rites_2025_720p_WEB-DL_YIFY.mp4" type="video/mp4">
    <track id="subtitleTrack" src="fa.vtt" kind="subtitles" srclang="fa" label="Persian" default>
    Your browser does not support the video.
  </video>

  <div id="customSubtitleLayer">
      <span id="customSubtitleText"></span>
  </div>

  <div class="loader-wrap" id="loaderWrap"><div class="spinner"></div></div>
  <div class="center-play-overlay" id="centerPlayBtn"><i class="material-icons">play_arrow</i></div>
  <div class="seek-feedback left" id="seekFeedbackLeft"><i class="material-icons">replay_10</i></div>
  <div class="seek-feedback right" id="seekFeedbackRight"><i class="material-icons">forward_10</i></div>
  
  <div class="controls" id="controls">
    <div class="progress-wrap" id="progressWrap">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="seek-tooltip" id="seekTooltip">00:00</div> 
    </div>
    
    <div class="controls-row">
      <div class="section-left">
        <button id="playBtn" class="icon"><i class="material-icons">play_arrow</i></button>
        
        <div class="volume-control">
          <button id="muteBtn" class="icon"><i class="material-icons" id="muteIcon">volume_up</i></button>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="1">
        </div>
        
        <div class="time-display">
          <span id="currentTime">00:00</span>&nbsp;/&nbsp;<span id="totalDuration">00:00</span>
        </div>
      </div>

      <div class="section-center-spacer"></div>

      <div class="section-right">
        <div class="icon-group">
          <button id="ccBtn" class="icon"><i class="material-icons">closed_caption</i></button>
          <button id="settingsBtn" class="icon"><i class="material-icons">settings</i></button>

          <div class="settings-menu-container" id="settingsMenu">
            <div class="menu-content active-panel" id="mainMenuPanel">
               <div class="panel-header" style="justify-content:center; border:none;">Settings</div>
               <button class="menu-item" id="toSpeedBtn">
                 <div style="display:flex; align-items:center"><i class="material-icons left-icon">slow_motion_video</i> <span>Speed</span></div>
                 <div class="menu-value"><span id="currentSpeedText">Normal</span> <i class="material-icons" style="font-size:16px;">chevron_right</i></div>
               </button>
               <button class="menu-item" id="toSubSettingsBtn">
                 <div style="display:flex; align-items:center"><i class="material-icons left-icon">text_format</i> <span>Subtitle</span></div>
                 <div class="menu-value"><i class="material-icons" style="font-size:16px;">chevron_right</i></div>
               </button>
            </div>
            
            <div class="menu-content" id="speedPanel">
                <div class="panel-header">
                   <button class="icon back-btn" data-target="mainMenuPanel"><i class="material-icons">arrow_forward</i></button>
                   <span>Speed</span>
                </div>
                <button class="menu-item" data-speed="0.5">0.5x</button>
                <button class="menu-item selected" data-speed="1">1x (Normal)</button>
                <button class="menu-item" data-speed="1.25">1.25x</button>
                <button class="menu-item" data-speed="1.5">1.5x</button>
                <button class="menu-item" data-speed="2">2x</button>
            </div>
            <div class="menu-content" id="subMainPanel">
                <div class="panel-header">
                   <button class="icon back-btn" data-target="mainMenuPanel"><i class="material-icons">arrow_forward</i></button>
                   <span>Subtitle</span>
                </div>
                <button class="menu-item" id="toSubColorBtn">
                   <div style="display:flex; align-items:center"><i class="material-icons left-icon">palette</i> <span>Color</span></div>
                   <div class="menu-value"><i class="material-icons" style="font-size:16px;">chevron_right</i></div>
                </button>
                <button class="menu-item" id="toSubSizeBtn">
                   <div style="display:flex; align-items:center"><i class="material-icons left-icon">format_size</i> <span>Size</span></div>
                   <div class="menu-value"><i class="material-icons" style="font-size:16px;">chevron_right</i></div>
                </button>
                <button class="menu-item" id="toSubPosBtn">
                   <div style="display:flex; align-items:center"><i class="material-icons left-icon">vertical_align_center</i> <span>Position</span></div>
                   <div class="menu-value"><i class="material-icons" style="font-size:16px;">chevron_right</i></div>
                </button>
            </div>
            <div class="menu-content" id="subColorPanel">
                <div class="panel-header">
                   <button class="icon back-btn" data-target="subMainPanel"><i class="material-icons">arrow_forward</i></button>
                   <span>Color</span>
                </div>
                <div class="color-grid">
                   <div class="color-swatch" style="background:#ffffff" data-color="#ffffff"></div>
                   <div class="color-swatch" style="background:#ffeb3b" data-color="#ffeb3b"></div>
                   <div class="color-swatch" style="background:#00e676" data-color="#00e676"></div>
                   <div class="color-swatch" style="background:#2979ff" data-color="#2979ff"></div>
                   <div class="color-swatch" style="background:#ff1744" data-color="#ff1744"></div>
                </div>
            </div>
            <div class="menu-content" id="subSizePanel">
                <div class="panel-header">
                   <button class="icon back-btn" data-target="subMainPanel"><i class="material-icons">arrow_forward</i></button>
                   <span>Size</span>
                </div>
                <div class="setting-slider-wrap">
                    <input type="range" id="subSizeRange" class="setting-slider" min="12" max="36" step="2" value="16">
                    <div style="text-align:center;font-size:12px;opacity:0.7">Small ----------------- Large</div>
                </div>
            </div>
            <div class="menu-content" id="subPosPanel">
                <div class="panel-header">
                   <button class="icon back-btn" data-target="subMainPanel"><i class="material-icons">arrow_forward</i></button>
                   <span>Position</span>
                </div>
                <div class="setting-slider-wrap">
                    <input type="range" id="subPosRange" class="setting-slider" min="20" max="250" step="10" value="70">
                    <div style="text-align:center;font-size:12px;opacity:0.7">Bottom ----------------- Top</div>
                </div>
            </div>
          </div>
          <button id="pipBtn" class="icon"><i class="material-icons">picture_in_picture_alt</i></button>
          <button id="fsBtn" class="icon"><i class="material-icons">fullscreen</i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // --- CINEMATIC INTRO ---
  const overlay = document.getElementById('overlay');
  const welcome1 = document.getElementById('welcome1');
  const welcome2 = document.getElementById('welcome2');
  const welcome3 = document.getElementById('welcome3');
  const playerWrap = document.getElementById('playerWrap');

  function cinematicIntro() {
    setTimeout(() => { welcome1.style.opacity = 1; welcome1.style.transform = 'translateZ(0px)'; }, 800);
    setTimeout(() => { welcome1.style.opacity = 0; }, 1800);
    setTimeout(() => { welcome2.style.opacity = 1; welcome2.style.transform = 'translateZ(0px)'; }, 2000);
    setTimeout(() => { welcome2.style.opacity = 0; }, 3000);
    setTimeout(() => { welcome3.style.opacity = 1; welcome3.style.transform = 'translateZ(0px)'; }, 3200);
    setTimeout(() => { welcome3.style.opacity = 0; }, 4700);
    setTimeout(() => { overlay.style.opacity = 0; playerWrap.style.opacity = 1; setTimeout(()=>overlay.style.display='none',1000); }, 4900);
  }
  window.addEventListener('load', cinematicIntro);

  // --- PLAYER VARIABLES ---
  const video = document.getElementById('video');
  const controls = document.getElementById('controls');
  const playBtn = document.getElementById('playBtn');
  const centerPlayBtn = document.getElementById('centerPlayBtn');
  const muteBtn = document.getElementById('muteBtn');
  const volumeSlider = document.getElementById('volume');
  const progressWrap = document.getElementById('progressWrap');
  const bar = document.getElementById('bar');
  const currentTimeEl = document.getElementById('currentTime');
  const totalDurationEl = document.getElementById('totalDuration');
  const seekTooltip = document.getElementById('seekTooltip'); 
  const fsBtn = document.getElementById('fsBtn');
  const pipBtn = document.getElementById('pipBtn');
  const loaderWrap = document.getElementById('loaderWrap');
  const ccBtn = document.getElementById('ccBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsMenu = document.getElementById('settingsMenu');
  
  let isSubtitleEnabled = true;
  const customSubtitleLayer = document.getElementById('customSubtitleLayer');
  const customSubtitleText = document.getElementById('customSubtitleText');
  const savedSubSettings = JSON.parse(localStorage.getItem('subSettings')) || { color: '#ffffff', size: 16, pos: 70 };
  
  let hideControlsTimer;
  let isDragging = false;

  // --- SUBTITLES ---
  function initSubtitles() {
    const track = video.textTracks[0];
    if(track) {
        track.mode = 'hidden'; 
        ccBtn.classList.add('active');
        track.oncuechange = () => {
             if(isSubtitleEnabled && track.activeCues[0]) {
                 customSubtitleText.textContent = track.activeCues[0].text;
                 customSubtitleLayer.style.display = 'block';
             } else {
                 customSubtitleText.textContent = '';
                 customSubtitleLayer.style.display = 'none';
             }
        };
    }
  }
  video.addEventListener('loadedmetadata', initSubtitles);

  function applySubSettings() {
      customSubtitleText.style.color = savedSubSettings.color;
      customSubtitleText.style.fontSize = savedSubSettings.size + 'px';
      customSubtitleLayer.style.bottom = savedSubSettings.pos + 'px';
      document.getElementById('subSizeRange').value = savedSubSettings.size;
      document.getElementById('subPosRange').value = savedSubSettings.pos;
      document.querySelectorAll('.color-swatch').forEach(s => {
         s.classList.toggle('active-swatch', s.dataset.color === savedSubSettings.color);
      });
  }
  applySubSettings();
  
  function saveSettings() { localStorage.setItem('subSettings', JSON.stringify(savedSubSettings)); }

  // --- MENU LISTENERS ---
  const panels = {
      main: document.getElementById('mainMenuPanel'), speed: document.getElementById('speedPanel'),
      subMain: document.getElementById('subMainPanel'), subColor: document.getElementById('subColorPanel'),
      subSize: document.getElementById('subSizePanel'), subPos: document.getElementById('subPosPanel')
  };
  function switchPanel(name) {
      Object.values(panels).forEach(p => p.classList.remove('active-panel'));
      panels[name].classList.add('active-panel');
  }
  settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsMenu.classList.toggle('active'); });
  window.addEventListener('click', (e) => {
    if(!e.target.closest('.settings-menu-container') && !e.target.closest('#settingsBtn')) {
        settingsMenu.classList.remove('active'); setTimeout(() => switchPanel('main'), 300); 
    }
  });
  document.querySelectorAll('.back-btn').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); switchPanel(btn.dataset.target === 'mainMenuPanel' ? 'main' : 'subMain'); });
  });
  document.getElementById('toSpeedBtn').addEventListener('click', () => switchPanel('speed'));
  document.getElementById('toSubSettingsBtn').addEventListener('click', () => switchPanel('subMain'));
  document.getElementById('toSubColorBtn').addEventListener('click', () => switchPanel('subColor'));
  document.getElementById('toSubSizeBtn').addEventListener('click', () => switchPanel('subSize'));
  document.getElementById('toSubPosBtn').addEventListener('click', () => switchPanel('subPos'));
  document.querySelectorAll('[data-speed]').forEach(btn => {
      btn.addEventListener('click', () => {
          video.playbackRate = parseFloat(btn.dataset.speed);
          document.querySelectorAll('[data-speed]').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          document.getElementById('currentSpeedText').textContent = btn.textContent;
          switchPanel('main');
      });
  });
  document.querySelectorAll('.color-swatch').forEach(swatch => {
      swatch.addEventListener('click', () => {
          savedSubSettings.color = swatch.dataset.color; applySubSettings(); saveSettings();
      });
  });
  document.getElementById('subSizeRange').addEventListener('input', (e) => {
      savedSubSettings.size = e.target.value; applySubSettings(); saveSettings();
  });
  document.getElementById('subPosRange').addEventListener('input', (e) => {
      savedSubSettings.pos = e.target.value; applySubSettings(); saveSettings();
  });

  // --- PLAYBACK CONTROLS ---
  function togglePlay(){ if (video.paused) video.play(); else video.pause(); }
  function updatePlayState() {
    if(video.paused || video.ended) {
        playBtn.querySelector('i').textContent = 'play_arrow';
        playerWrap.classList.add('paused'); showControls();
        centerPlayBtn.querySelector('i').textContent = 'play_arrow';
        centerPlayBtn.classList.add('show-icon'); setTimeout(()=>centerPlayBtn.classList.remove('show-icon'), 800);
    } else {
        playBtn.querySelector('i').textContent = 'pause';
        playerWrap.classList.remove('paused'); startHideTimer();
        centerPlayBtn.querySelector('i').textContent = 'pause';
        centerPlayBtn.classList.add('show-icon'); setTimeout(()=>centerPlayBtn.classList.remove('show-icon'), 800);
    }
  }
  playBtn.addEventListener('click', togglePlay);
  video.addEventListener('play', updatePlayState);
  video.addEventListener('pause', updatePlayState);
  video.addEventListener('click', (e) => { if(window.innerWidth > 768) togglePlay(); });

  // --- TOUCH / MOUSE CONTROLS ---
  function showControls() { playerWrap.classList.remove('hide-controls'); clearTimeout(hideControlsTimer); }
  function hideControls() { if (!video.paused && !settingsMenu.classList.contains('active')) playerWrap.classList.add('hide-controls'); }
  function startHideTimer() { clearTimeout(hideControlsTimer); hideControlsTimer = setTimeout(hideControls, 3000); }
  playerWrap.addEventListener('mousemove', () => { showControls(); if(!video.paused) startHideTimer(); });

  let lastTapTime = 0;
  playerWrap.addEventListener('touchstart', (e) => {
      if(e.target.closest('.controls') || e.target.closest('.settings-menu-container')) return;
      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTapTime;
      lastTapTime = currentTime;
      if (tapLength < 300 && tapLength > 0) {
          e.preventDefault(); 
          const touchX = e.changedTouches[0].clientX;
          if(touchX < playerWrap.offsetWidth / 2) {
              video.currentTime -= 10; showFeedback(document.getElementById('seekFeedbackLeft'));
          } else {
              video.currentTime += 10; showFeedback(document.getElementById('seekFeedbackRight'));
          }
      } else {
          setTimeout(() => {
              if (new Date().getTime() - lastTapTime >= 300) {
                  if(playerWrap.classList.contains('hide-controls')) { showControls(); startHideTimer(); } else { hideControls(); }
              }
          }, 300);
      }
  });
  function showFeedback(el) { el.classList.remove('show'); void el.offsetWidth; el.classList.add('show'); }

  // --- PROGRESS BAR LOGIC (FIXED) ---
  progressWrap.addEventListener('mousedown', (e)=>{ isDragging = true; seek(e); });
  progressWrap.addEventListener('touchstart', (e)=>{ isDragging = true; seek(e.touches[0]); }, {passive: false});
  window.addEventListener('mousemove', (e)=>{ if(isDragging) seek(e); });
  window.addEventListener('touchmove', (e)=>{ if(isDragging) seek(e.touches[0]); }, {passive: false});
  window.addEventListener('mouseup', ()=>{ isDragging = false; });
  window.addEventListener('touchend', ()=>{ isDragging = false; });

  // *** FIXED TOOLTIP LOGIC ***
  progressWrap.addEventListener('mousemove', (e) => {
      const rect = progressWrap.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      const safePct = Math.min(Math.max(0, pct), 1);
      seekTooltip.style.left = (safePct * 100) + '%';
      seekTooltip.textContent = formatTime(safePct * (video.duration || 0));
  });

  function seek(e) {
    const rect = progressWrap.getBoundingClientRect();
    const pct = Math.min(Math.max(0, e.clientX - rect.left), rect.width) / rect.width;
    bar.style.width = (pct*100)+'%';
    video.currentTime = pct * video.duration;
  }

  // --- TIME UPDATE (FIXED) ---
  function formatTime(s){
    if (!isFinite(s)) return '00:00';
    const m = Math.floor(s/60), sec = Math.floor(s%60), h = Math.floor(s/3600);
    if (h > 0) return `${h}:${String(m%60).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    return `${m}:${String(sec).padStart(2,'0')}`;
  }
  
  video.addEventListener('timeupdate', ()=>{
    if(!isDragging) {
        const pct = (video.currentTime / video.duration) * 100;
        bar.style.width = pct + '%';
        currentTimeEl.textContent = formatTime(video.currentTime);
    }
  });
  video.addEventListener('loadedmetadata', ()=> totalDurationEl.textContent = formatTime(video.duration));

  // --- EXTRA CONTROLS ---
  volumeSlider.addEventListener('input', () => { video.volume = volumeSlider.value; video.muted = video.volume === 0; });
  muteBtn.addEventListener('click', () => { video.muted = !video.muted; });
  fsBtn.addEventListener('click', () => !document.fullscreenElement ? playerWrap.requestFullscreen() : document.exitFullscreen());
  pipBtn.addEventListener('click', () => document.pictureInPictureElement ? document.exitPictureInPicture() : video.requestPictureInPicture());
  ccBtn.addEventListener('click', () => { 
      isSubtitleEnabled = !isSubtitleEnabled; 
      ccBtn.classList.toggle('active', isSubtitleEnabled);
      if(!isSubtitleEnabled) customSubtitleText.textContent = '';
  });
  video.addEventListener('waiting', ()=>loaderWrap.classList.add('active'));
  video.addEventListener('playing', ()=>loaderWrap.classList.remove('active'));

})();
</script>
</body>
</html>

